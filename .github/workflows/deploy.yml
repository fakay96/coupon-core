name: Deploy to DigitalOcean Kubernetes

on:
  workflow_call:
    inputs:
      version_tag:
        description: 'The version tag to deploy'
        required: true
        type: string
    secrets:
      KUBECONFIG_CONTENT:
        required: true

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl for DigitalOcean
        run: |
          mkdir -p ~/.kube
          echo "Creating kubeconfig from raw YAML content..."
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify kubeconfig file and access
        run: |
          echo "Verifying kubeconfig file..."
          kubectl get nodes

      - name: Uninstall previous Helm releases
        continue-on-error: true
        run: |
          helm uninstall backend-service --namespace production || echo "backend-service not installed."

      - name: Debug Helm chart path
        run: |
          ls -l ./k8s/backend
          ls -l ./k8s/backend/values/

      - name: Debug Helm values rendering
        run: |
          helm template backend-service ./k8s/backend \
            --set backend.image.repository=fakay96/backend \
            --set backend.image.tag=${{ inputs.version_tag }} \
            -f ./k8s/backend/values/production-values.yaml

      - name: Deploy backend service with Helm
        env:
          VERSION_TAG: ${{ inputs.version_tag }}
        run: |
          helm upgrade --install backend-service ./k8s/backend \
            --set backend.image.repository=fakay96/backend \
            --set backend.image.tag=${VERSION_TAG} \
            --namespace production --create-namespace \
            -f ./k8s/backend/values/production-values.yaml

      - name: Verify deployment status
        run: |
          kubectl rollout status deployment backend -n production --timeout=300s

      # Step 8: Rollback on failure (optional)
      - name: Rollback to previous version on failure
        if: failure()
        run: |
          echo "Deployment failed. Rolling back to previous versions."
          helm rollback backend-service 1 --namespace production
